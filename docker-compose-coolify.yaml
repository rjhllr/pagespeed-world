services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
        environment:
            APP_ENV: '${APP_ENV:-production}'
            APP_KEY: '${APP_KEY}'
            APP_DEBUG: '${APP_DEBUG:-false}'
            APP_URL: '${APP_URL}'
            DB_CONNECTION: mysql
            DB_HOST: mysql
            DB_PORT: 3306
            DB_DATABASE: '${DB_DATABASE}'
            DB_USERNAME: '${DB_USERNAME}'
            DB_PASSWORD: '${DB_PASSWORD}'
            REDIS_HOST: redis
            REDIS_PORT: 6379
            CACHE_STORE: redis
            SESSION_DRIVER: redis
            QUEUE_CONNECTION: redis
            PSI_API_KEY: '${PSI_API_KEY}'
        volumes:
            - 'psi-storage:/var/www/html/storage/app'
        networks:
            - psi-network
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_healthy
        restart: unless-stopped

    horizon:
        build:
            context: .
            dockerfile: Dockerfile
        command: php artisan horizon
        environment:
            APP_ENV: '${APP_ENV:-production}'
            APP_KEY: '${APP_KEY}'
            APP_DEBUG: '${APP_DEBUG:-false}'
            APP_URL: '${APP_URL}'
            DB_CONNECTION: mysql
            DB_HOST: mysql
            DB_PORT: 3306
            DB_DATABASE: '${DB_DATABASE}'
            DB_USERNAME: '${DB_USERNAME}'
            DB_PASSWORD: '${DB_PASSWORD}'
            REDIS_HOST: redis
            REDIS_PORT: 6379
            CACHE_STORE: redis
            SESSION_DRIVER: redis
            QUEUE_CONNECTION: redis
            PSI_API_KEY: '${PSI_API_KEY}'
            PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'
            PUPPETEER_EXECUTABLE_PATH: '/usr/bin/chromium-browser'
        networks:
            - psi-network
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_healthy
        restart: unless-stopped

    scheduler:
        build:
            context: .
            dockerfile: Dockerfile
        command: /bin/sh -c "while true; do php artisan schedule:run --verbose; sleep 60; done"
        environment:
            APP_ENV: '${APP_ENV:-production}'
            APP_KEY: '${APP_KEY}'
            APP_DEBUG: '${APP_DEBUG:-false}'
            APP_URL: '${APP_URL}'
            DB_CONNECTION: mysql
            DB_HOST: mysql
            DB_PORT: 3306
            DB_DATABASE: '${DB_DATABASE}'
            DB_USERNAME: '${DB_USERNAME}'
            DB_PASSWORD: '${DB_PASSWORD}'
            REDIS_HOST: redis
            REDIS_PORT: 6379
            CACHE_STORE: redis
            SESSION_DRIVER: redis
            QUEUE_CONNECTION: redis
            PSI_API_KEY: '${PSI_API_KEY}'
        networks:
            - psi-network
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_healthy
        restart: unless-stopped

    mysql:
        image: 'mysql:8.4'
        environment:
            MYSQL_ROOT_PASSWORD: '${DB_PASSWORD}'
            MYSQL_ROOT_HOST: '%'
            MYSQL_DATABASE: '${DB_DATABASE}'
            MYSQL_USER: '${DB_USERNAME}'
            MYSQL_PASSWORD: '${DB_PASSWORD}'
        volumes:
            - 'psi-mysql:/var/lib/mysql'
        networks:
            - psi-network
        healthcheck:
            test:
                - CMD
                - mysqladmin
                - ping
                - '-p${DB_PASSWORD}'
            retries: 3
            timeout: 5s
        restart: unless-stopped

    redis:
        image: 'redis:alpine'
        volumes:
            - 'psi-redis:/data'
        networks:
            - psi-network
        healthcheck:
            test:
                - CMD
                - redis-cli
                - ping
            retries: 3
            timeout: 5s
        restart: unless-stopped

networks:
    psi-network:
        driver: bridge

volumes:
    psi-mysql:
        driver: local
    psi-redis:
        driver: local
    psi-storage:
        driver: local
